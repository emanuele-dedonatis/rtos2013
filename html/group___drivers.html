<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>STM32F4 Pedometer: Drivers</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">STM32F4 Pedometer
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">A pedometer library for the STM32F4 Discovery board by ST Microelectronics.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">Drivers</div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:ga63e91009cf974e4c121ad89e7fe9beb0"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><b>saveContextFromSwi</b>()</td></tr>
<tr class="separator:ga63e91009cf974e4c121ad89e7fe9beb0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga5bc7a8d3a87aba81cecd73c4d0972449"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___drivers.html#ga5bc7a8d3a87aba81cecd73c4d0972449">saveContextFromIrq</a>()</td></tr>
<tr class="separator:ga5bc7a8d3a87aba81cecd73c4d0972449"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga9c44075f57f61dc7b14637f1973776bc"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___drivers.html#ga9c44075f57f61dc7b14637f1973776bc">restoreContext</a>()</td></tr>
<tr class="separator:ga9c44075f57f61dc7b14637f1973776bc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gab1359cc5bc2531333baf9ef3e4718336"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___drivers.html#gab1359cc5bc2531333baf9ef3e4718336">enableIRQandFIQ</a>()</td></tr>
<tr class="separator:gab1359cc5bc2531333baf9ef3e4718336"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga21a05ff59779a634de98b1d3436fd608"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___drivers.html#ga21a05ff59779a634de98b1d3436fd608">disableIRQandFIQ</a>()</td></tr>
<tr class="separator:ga21a05ff59779a634de98b1d3436fd608"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga95d67df1cf6117ce43766d06b8113297"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><b>saveContext</b>()</td></tr>
<tr class="separator:ga95d67df1cf6117ce43766d06b8113297"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga9c44075f57f61dc7b14637f1973776bc"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___drivers.html#ga9c44075f57f61dc7b14637f1973776bc">restoreContext</a>()</td></tr>
<tr class="separator:ga9c44075f57f61dc7b14637f1973776bc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga95d67df1cf6117ce43766d06b8113297"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><b>saveContext</b>()</td></tr>
<tr class="separator:ga95d67df1cf6117ce43766d06b8113297"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga9c44075f57f61dc7b14637f1973776bc"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___drivers.html#ga9c44075f57f61dc7b14637f1973776bc">restoreContext</a>()</td></tr>
<tr class="separator:ga9c44075f57f61dc7b14637f1973776bc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga95d67df1cf6117ce43766d06b8113297"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><b>saveContext</b>()</td></tr>
<tr class="separator:ga95d67df1cf6117ce43766d06b8113297"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga9c44075f57f61dc7b14637f1973776bc"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___drivers.html#ga9c44075f57f61dc7b14637f1973776bc">restoreContext</a>()</td></tr>
<tr class="separator:ga9c44075f57f61dc7b14637f1973776bc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga95d67df1cf6117ce43766d06b8113297"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><b>saveContext</b>()</td></tr>
<tr class="separator:ga95d67df1cf6117ce43766d06b8113297"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga9c44075f57f61dc7b14637f1973776bc"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___drivers.html#ga9c44075f57f61dc7b14637f1973776bc">restoreContext</a>()</td></tr>
<tr class="separator:ga9c44075f57f61dc7b14637f1973776bc"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:gabde377c6777ad3f4aecde34ee1e26df4"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="gabde377c6777ad3f4aecde34ee1e26df4"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><b>miosix_private::doYield</b> ()</td></tr>
<tr class="separator:gabde377c6777ad3f4aecde34ee1e26df4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga961407a501c1247188dcdf5f60e8f301"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ga961407a501c1247188dcdf5f60e8f301"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><b>miosix_private::doDisableInterrupts</b> ()</td></tr>
<tr class="separator:ga961407a501c1247188dcdf5f60e8f301"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga81e39c3699a44c981d94c17a64722f41"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ga81e39c3699a44c981d94c17a64722f41"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><b>miosix_private::doEnableInterrupts</b> ()</td></tr>
<tr class="separator:ga81e39c3699a44c981d94c17a64722f41"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga392ef99b87ee6feb2805dee3790f9648"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ga392ef99b87ee6feb2805dee3790f9648"></a>
bool&#160;</td><td class="memItemRight" valign="bottom"><b>miosix_private::checkAreInterruptsEnabled</b> ()</td></tr>
<tr class="separator:ga392ef99b87ee6feb2805dee3790f9648"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:ga8a5f91e2c91d35597d0f7ba85f99898b"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ga8a5f91e2c91d35597d0f7ba85f99898b"></a>
volatile unsigned int *&#160;</td><td class="memItemRight" valign="bottom"><b>ctxsave</b></td></tr>
<tr class="separator:ga8a5f91e2c91d35597d0f7ba85f99898b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga8a5f91e2c91d35597d0f7ba85f99898b"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ga8a5f91e2c91d35597d0f7ba85f99898b"></a>
volatile unsigned int *&#160;</td><td class="memItemRight" valign="bottom"><b>ctxsave</b></td></tr>
<tr class="separator:ga8a5f91e2c91d35597d0f7ba85f99898b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga8a5f91e2c91d35597d0f7ba85f99898b"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ga8a5f91e2c91d35597d0f7ba85f99898b"></a>
volatile unsigned int *&#160;</td><td class="memItemRight" valign="bottom"><b>ctxsave</b></td></tr>
<tr class="separator:ga8a5f91e2c91d35597d0f7ba85f99898b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga8a5f91e2c91d35597d0f7ba85f99898b"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ga8a5f91e2c91d35597d0f7ba85f99898b"></a>
volatile unsigned int *&#160;</td><td class="memItemRight" valign="bottom"><b>ctxsave</b></td></tr>
<tr class="separator:ga8a5f91e2c91d35597d0f7ba85f99898b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga8a5f91e2c91d35597d0f7ba85f99898b"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ga8a5f91e2c91d35597d0f7ba85f99898b"></a>
volatile unsigned int *&#160;</td><td class="memItemRight" valign="bottom"><b>ctxsave</b></td></tr>
<tr class="separator:ga8a5f91e2c91d35597d0f7ba85f99898b"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>Miosix drivers API</p>
<p>Contains functions and macros that can be used to write drivers for hardware peripherals. These functions, plus the IRQ methods of the Queue class provide a way to transfer data between an interrupt routine and user code, and a way to cause preemption inside an interrupt routine to wake a higher priority Thread waiting on some hardware peripheral.</p>
<p>Also contains the default drivers for each architecture. </p>
<h2 class="groupheader">Macro Definition Documentation</h2>
<a class="anchor" id="ga21a05ff59779a634de98b1d3436fd608"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define disableIRQandFIQ</td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">{                                                                               \</div>
<div class="line"> asm <span class="keyword">volatile</span>(<span class="stringliteral">&quot;.set  I_BIT, 0x80            \n\t&quot;</span>                   \</div>
<div class="line">              <span class="stringliteral">&quot;.set  F_BIT, 0x40            \n\t&quot;</span>                   \</div>
<div class="line">              <span class="stringliteral">&quot;mrs r0, cpsr             \n\t&quot;</span>                   \</div>
<div class="line">              <span class="stringliteral">&quot;orr r0, r0, #I_BIT|F_BIT                 \n\t&quot;</span>                   \</div>
<div class="line">              <span class="stringliteral">&quot;msr cpsr_c, r0               \n\t&quot;</span>                   \</div>
<div class="line">              :::<span class="stringliteral">&quot;r0&quot;</span>);                                                         \</div>
<div class="line">}</div>
</div><!-- fragment --><p>Disable interrupts (both irq and fiq)<br/>
 If you are not using FIQ you should use <a class="el" href="group___kernel.html#ga36adaaa176d004747d2a01b822c9fea5">enableInterrupts()</a> </p>

</div>
</div>
<a class="anchor" id="gab1359cc5bc2531333baf9ef3e4718336"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define enableIRQandFIQ</td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">{                                                                               \</div>
<div class="line"> asm <span class="keyword">volatile</span>(<span class="stringliteral">&quot;.set  I_BIT, 0x80            \n\t&quot;</span>                   \</div>
<div class="line">              <span class="stringliteral">&quot;.set  F_BIT, 0x40                        \n\t&quot;</span>                   \</div>
<div class="line">              <span class="stringliteral">&quot;mrs r0, cpsr                             \n\t&quot;</span>                   \</div>
<div class="line">              <span class="stringliteral">&quot;and r0, r0, #~(I_BIT|F_BIT)              \n\t&quot;</span>                   \</div>
<div class="line">              <span class="stringliteral">&quot;msr cpsr_c, r0               \n\t&quot;</span>                   \</div>
<div class="line">              :::<span class="stringliteral">&quot;r0&quot;</span>);                                                         \</div>
<div class="line">}</div>
</div><!-- fragment --><p>Enable interrupts (both irq and fiq)<br/>
 If you are not using FIQ you should use <a class="el" href="group___kernel.html#gacd7ef6e968c5c0b2ff45bf102388ea4d">disableInterrupts()</a> FIQ means fast interrupts, is another level of interrupts available in the ARM7 cpu. They are not used in miosix, and are available to the user. The main advantage of FIQ is that they can even interrupt IRQ, so they have a so high priority that can interrupt the kernel itself.<br/>
The disadvantage is that, since can interrupt the kernel at any time, all functions, including those marked as IRQ cannot be called when IRQ and FIQ are disabled. Therefore, data transfer between user code and FIQ is more difficult to implement than IRQ. Another disadvantage is that they are only available in the ARM cpu, so if the kernel will be ported to another cpu, they won't be available.<br/>
 To use FIQ the user must change the code of the default FIQ interrupt routine defined in miosix/drivers/interrupts.cpp<br/>
By default FIQ are enabled but no peripheral is associated with FIQ, so no FIQ interrupts will occur. </p>

</div>
</div>
<a class="anchor" id="ga9c44075f57f61dc7b14637f1973776bc"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define restoreContext</td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">{                                                                             \</div>
<div class="line">    asm <span class="keyword">volatile</span>(<span class="stringliteral">&quot;ldr   r0,  =ctxsave    \n\t&quot;</span> <span class="comment">/*get current context*/</span>        \</div>
<div class="line">                 <span class="stringliteral">&quot;ldr   r0,  [r0]        \n\t&quot;</span>                                \</div>
<div class="line">                 <span class="stringliteral">&quot;ldmia r0,  {r1,r4-r11} \n\t&quot;</span> <span class="comment">/*restore r4-r11 + r1=psp*/</span>    \</div>
<div class="line">                 <span class="stringliteral">&quot;msr   psp, r1          \n\t&quot;</span> <span class="comment">/*restore PROCESS sp*/</span>         \</div>
<div class="line">                 <span class="stringliteral">&quot;ldmia sp!, {pc}        \n\t&quot;</span> <span class="comment">/*return*/</span>                     \</div>
<div class="line">                 );                                                           \</div>
<div class="line">}</div>
</div><!-- fragment --><p>Restore context in an IRQ where saveContext() is used. Must be the last line of an IRQ where a context switch can happen. The IRQ must be "naked" to prevent the compiler from generating context restore. </p>

</div>
</div>
<a class="anchor" id="ga9c44075f57f61dc7b14637f1973776bc"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define restoreContext</td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">{                                                                             \</div>
<div class="line">    asm <span class="keyword">volatile</span>(<span class="stringliteral">&quot;ldr   r0,  =ctxsave    \n\t&quot;</span> <span class="comment">/*get current context*/</span>        \</div>
<div class="line">                 <span class="stringliteral">&quot;ldr   r0,  [r0]        \n\t&quot;</span>                                \</div>
<div class="line">                 <span class="stringliteral">&quot;ldmia r0,  {r1,r4-r11} \n\t&quot;</span> <span class="comment">/*restore r4-r11 + r1=psp*/</span>    \</div>
<div class="line">                 <span class="stringliteral">&quot;msr   psp, r1          \n\t&quot;</span> <span class="comment">/*restore PROCESS sp*/</span>         \</div>
<div class="line">                 <span class="stringliteral">&quot;ldmia sp!, {pc}        \n\t&quot;</span> <span class="comment">/*return*/</span>                     \</div>
<div class="line">                 );                                                           \</div>
<div class="line">}</div>
</div><!-- fragment --><p>Restore context in an IRQ where saveContext() is used. Must be the last line of an IRQ where a context switch can happen. The IRQ must be "naked" to prevent the compiler from generating context restore. </p>

</div>
</div>
<a class="anchor" id="ga9c44075f57f61dc7b14637f1973776bc"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define restoreContext</td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">{                                                                             \</div>
<div class="line">    asm <span class="keyword">volatile</span>(<span class="stringliteral">&quot;ldr   r0,  =ctxsave    \n\t&quot;</span> <span class="comment">/*get current context*/</span>        \</div>
<div class="line">                 <span class="stringliteral">&quot;ldr   r0,  [r0]        \n\t&quot;</span>                                \</div>
<div class="line">                 <span class="stringliteral">&quot;ldmia r0,  {r1,r4-r11} \n\t&quot;</span> <span class="comment">/*restore r4-r11 + r1=psp*/</span>    \</div>
<div class="line">                 <span class="stringliteral">&quot;msr   psp, r1          \n\t&quot;</span> <span class="comment">/*restore PROCESS sp*/</span>         \</div>
<div class="line">                 <span class="stringliteral">&quot;ldmia sp!, {pc}        \n\t&quot;</span> <span class="comment">/*return*/</span>                     \</div>
<div class="line">                 );                                                           \</div>
<div class="line">}</div>
</div><!-- fragment --><p>Restore context in an IRQ where saveContext() is used. Must be the last line of an IRQ where a context switch can happen. The IRQ must be "naked" to prevent the compiler from generating context restore. </p>

</div>
</div>
<a class="anchor" id="ga9c44075f57f61dc7b14637f1973776bc"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define restoreContext</td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">{                                                                              \</div>
<div class="line">    asm <span class="keyword">volatile</span>(<span class="stringliteral">&quot;   ldr    r0,  =ctxsave       \n&quot;</span><span class="comment">/*get current context    */</span> \</div>
<div class="line">                 <span class="stringliteral">&quot;   ldr    r0,  [r0]           \n&quot;</span>                            \</div>
<div class="line">                 <span class="stringliteral">&quot;   ldmia  r0!, {r1,r4-r11,lr} \n&quot;</span><span class="comment">/*load r1(psp),r4-r11,lr */</span> \</div>
<div class="line">                 <span class="stringliteral">&quot;   lsls   r2,  lr,  #27       \n&quot;</span><span class="comment">/*check if bit #4 is set */</span> \</div>
<div class="line">                 <span class="stringliteral">&quot;   bmi    0f                  \n&quot;</span>                            \</div>
<div class="line">                 <span class="stringliteral">&quot;   vldmia.32 r0, {s16-s31}    \n&quot;</span><span class="comment">/*restore s16-s31 if need*/</span> \</div>
<div class="line">                 <span class="stringliteral">&quot;0: msr    psp, r1             \n&quot;</span><span class="comment">/*restore PROCESS sp*/</span>      \</div>
<div class="line">                 <span class="stringliteral">&quot;   bx     lr                  \n&quot;</span><span class="comment">/*return*/</span>                  \</div>
<div class="line">                 );                                                            \</div>
<div class="line">}</div>
</div><!-- fragment --><p>Restore context in an IRQ where saveContext() is used. Must be the last line of an IRQ where a context switch can happen. The IRQ must be "naked" to prevent the compiler from generating context restore. </p>

</div>
</div>
<a class="anchor" id="ga9c44075f57f61dc7b14637f1973776bc"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define restoreContext</td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">{                                                                               \</div>
<div class="line">    asm <span class="keyword">volatile</span>(   <span class="comment">/*load ctxsave and dereference the pointer*/</span>            \</div>
<div class="line">                    <span class="comment">/*also add 64 to make it point to &quot;top of stack&quot;*/</span>          \</div>
<div class="line">                    <span class="stringliteral">&quot;ldr    lr,=ctxsave     \n\t&quot;</span>                   \</div>
<div class="line">                    <span class="stringliteral">&quot;ldr    lr,[lr]         \n\t&quot;</span>                   \</div>
<div class="line">                    <span class="stringliteral">&quot;add    lr,lr,#64       \n\t&quot;</span>                   \</div>
<div class="line">                    <span class="comment">/*restore spsr*/</span>                                            \</div>
<div class="line">                    <span class="comment">/*after this instructions, lr points to ctxsave[15] (return address)*/</span>  \</div>
<div class="line">                    <span class="stringliteral">&quot;ldmda  lr!,{r1}        \n\t&quot;</span>                   \</div>
<div class="line">                    <span class="stringliteral">&quot;msr    spsr,r1         \n\t&quot;</span>                   \</div>
<div class="line">                    <span class="comment">/*restore all thread registers except pc*/</span>                  \</div>
<div class="line">                    <span class="stringliteral">&quot;ldmdb  lr,{r0-lr}^     \n\t&quot;</span>                   \</div>
<div class="line">                    <span class="comment">/*add a nop as required after ldm ^ (read ARM reference about ldm(2))*/</span> \</div>
<div class="line">                    <span class="stringliteral">&quot;nop                                \n\t&quot;</span>                   \</div>
<div class="line">                    <span class="comment">/*now that lr points to return address, return from interrupt*/</span>         \</div>
<div class="line">                    <span class="stringliteral">&quot;ldr    lr,[lr]         \n\t&quot;</span>                   \</div>
<div class="line">                    <span class="stringliteral">&quot;movs   pc,lr           \n\t&quot;</span>);                 \</div>
<div class="line">}</div>
</div><!-- fragment --><p>Restore context in an IRQ where <a class="el" href="group___drivers.html#ga5bc7a8d3a87aba81cecd73c4d0972449">saveContextFromIrq()</a> (or saveContextFromSwi() ) is used. Must be the last line of an IRQ where a context switch can happen. The IRQ must be "naked" to prevent the compiler from generating context restore. </p>

</div>
</div>
<a class="anchor" id="ga95d67df1cf6117ce43766d06b8113297"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define saveContext</td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">{                                                                             \</div>
<div class="line">    asm <span class="keyword">volatile</span>(<span class="stringliteral">&quot;stmdb sp!, {lr}        \n\t&quot;</span> <span class="comment">/*save lr on MAIN stack*/</span>      \</div>
<div class="line">                 <span class="stringliteral">&quot;mrs   r1,  psp         \n\t&quot;</span> <span class="comment">/*get PROCESS stack pointer*/</span>  \</div>
<div class="line">                 <span class="stringliteral">&quot;ldr   r0,  =ctxsave    \n\t&quot;</span> <span class="comment">/*get current context*/</span>        \</div>
<div class="line">                 <span class="stringliteral">&quot;ldr   r0,  [r0]        \n\t&quot;</span>                                \</div>
<div class="line">                 <span class="stringliteral">&quot;stmia r0,  {r1,r4-r11} \n\t&quot;</span> <span class="comment">/*save PROCESS sp + r4-r11*/</span>   \</div>
<div class="line">                 );                                                           \</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ga95d67df1cf6117ce43766d06b8113297"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define saveContext</td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">{                                                                             \</div>
<div class="line">    asm <span class="keyword">volatile</span>(<span class="stringliteral">&quot;stmdb sp!, {lr}        \n\t&quot;</span> <span class="comment">/*save lr on MAIN stack*/</span>      \</div>
<div class="line">                 <span class="stringliteral">&quot;mrs   r1,  psp         \n\t&quot;</span> <span class="comment">/*get PROCESS stack pointer*/</span>  \</div>
<div class="line">                 <span class="stringliteral">&quot;ldr   r0,  =ctxsave    \n\t&quot;</span> <span class="comment">/*get current context*/</span>        \</div>
<div class="line">                 <span class="stringliteral">&quot;ldr   r0,  [r0]        \n\t&quot;</span>                                \</div>
<div class="line">                 <span class="stringliteral">&quot;stmia r0,  {r1,r4-r11} \n\t&quot;</span> <span class="comment">/*save PROCESS sp + r4-r11*/</span>   \</div>
<div class="line">                 );                                                           \</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ga95d67df1cf6117ce43766d06b8113297"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define saveContext</td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">{                                                                             \</div>
<div class="line">    asm <span class="keyword">volatile</span>(<span class="stringliteral">&quot;stmdb sp!, {lr}        \n\t&quot;</span> <span class="comment">/*save lr on MAIN stack*/</span>      \</div>
<div class="line">                 <span class="stringliteral">&quot;mrs   r1,  psp         \n\t&quot;</span> <span class="comment">/*get PROCESS stack pointer*/</span>  \</div>
<div class="line">                 <span class="stringliteral">&quot;ldr   r0,  =ctxsave    \n\t&quot;</span> <span class="comment">/*get current context*/</span>        \</div>
<div class="line">                 <span class="stringliteral">&quot;ldr   r0,  [r0]        \n\t&quot;</span>                                \</div>
<div class="line">                 <span class="stringliteral">&quot;stmia r0,  {r1,r4-r11} \n\t&quot;</span> <span class="comment">/*save PROCESS sp + r4-r11*/</span>   \</div>
<div class="line">                 );                                                           \</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ga95d67df1cf6117ce43766d06b8113297"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define saveContext</td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">{                                                                              \</div>
<div class="line">    asm <span class="keyword">volatile</span>(<span class="stringliteral">&quot;   mrs    r1,  psp            \n&quot;</span><span class="comment">/*get PROCESS stack ptr  */</span> \</div>
<div class="line">                 <span class="stringliteral">&quot;   ldr    r0,  =ctxsave       \n&quot;</span><span class="comment">/*get current context    */</span> \</div>
<div class="line">                 <span class="stringliteral">&quot;   ldr    r0,  [r0]           \n&quot;</span>                            \</div>
<div class="line">                 <span class="stringliteral">&quot;   stmia  r0!, {r1,r4-r11,lr} \n&quot;</span><span class="comment">/*save r1(psp),r4-r11,lr */</span> \</div>
<div class="line">                 <span class="stringliteral">&quot;   lsls   r2,  lr,  #27       \n&quot;</span><span class="comment">/*check if bit #4 is set */</span> \</div>
<div class="line">                 <span class="stringliteral">&quot;   bmi    0f                  \n&quot;</span>                            \</div>
<div class="line">                 <span class="stringliteral">&quot;   vstmia.32 r0, {s16-s31}    \n&quot;</span><span class="comment">/*save s16-s31 if we need*/</span> \</div>
<div class="line">                 <span class="stringliteral">&quot;0:                            \n&quot;</span>                            \</div>
<div class="line">                 );                                                            \</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ga5bc7a8d3a87aba81cecd73c4d0972449"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define saveContextFromIrq</td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">{                                                                               \</div>
<div class="line">    asm <span class="keyword">volatile</span>(   <span class="comment">/*Adjust lr, because the return address in a ISR has a 4 bytes offset*/</span> \</div>
<div class="line">                    <span class="stringliteral">&quot;sub    lr,lr,#4        \n\t&quot;</span>);                 \</div>
<div class="line">    saveContextFromSwi();                                                \</div>
<div class="line">}</div>
</div><!-- fragment --><p>Save context from an IRQ<br/>
 Must be the first line of an IRQ where a context switch can happen. The IRQ must be "naked" to prevent the compiler from generating context save. </p>

</div>
</div>
<a class="anchor" id="ga63e91009cf974e4c121ad89e7fe9beb0"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define saveContextFromSwi</td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">{                                                                               \</div>
<div class="line">    asm <span class="keyword">volatile</span>(   <span class="comment">/*push lr on stack, to use it as a general purpose reg.*/</span>   \</div>
<div class="line">                    <span class="stringliteral">&quot;stmfd  sp!,{lr}        \n\t&quot;</span>                   \</div>
<div class="line">                    <span class="comment">/*load ctxsave and dereference the pointer*/</span>                \</div>
<div class="line">                    <span class="stringliteral">&quot;ldr    lr,=ctxsave     \n\t&quot;</span>                   \</div>
<div class="line">                    <span class="stringliteral">&quot;ldr    lr,[lr]         \n\t&quot;</span>                   \</div>
<div class="line">                    <span class="comment">/*save all thread registers except pc*/</span>                     \</div>
<div class="line">                    <span class="stringliteral">&quot;stmia  lr,{r0-lr}^     \n\t&quot;</span>                   \</div>
<div class="line">                    <span class="comment">/*add a nop as required after stm ^ (read ARM reference about stm(2))*/</span> \</div>
<div class="line">                    <span class="stringliteral">&quot;nop                \n\t&quot;</span>                   \</div>
<div class="line">                    <span class="comment">/*move lr to r0, restore original lr (return address) and save it*/</span>     \</div>
<div class="line">                    <span class="stringliteral">&quot;add    r0,lr,#60       \n\t&quot;</span>                   \</div>
<div class="line">                    <span class="stringliteral">&quot;ldmfd  sp!,{lr}        \n\t&quot;</span>                   \</div>
<div class="line">                    <span class="stringliteral">&quot;stmia  r0!,{lr}        \n\t&quot;</span>                   \</div>
<div class="line">                    <span class="comment">/*save spsr on top of ctxsave*/</span>                             \</div>
<div class="line">                    <span class="stringliteral">&quot;mrs    r1,spsr         \n\t&quot;</span>                   \</div>
<div class="line">                    <span class="stringliteral">&quot;stmia  r0,{r1}         \n\t&quot;</span>);                 \</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Mar 31 2014 12:53:01 for STM32F4 Pedometer by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
